name: Frontend — Build & Deploy

on:
  push:
    branches:
      - main
    paths:
      - "apps/web/**"
      - "packages/ui/**"
      - ".github/workflows/frontend.yml"

jobs:
  deploy:
    name: Build & Deploy to Netlify
    runs-on: ubuntu-latest

    steps:
      # ── Checkout ────────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Toolchain ───────────────────────────────────────────────────────────
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up pnpm 8
        uses: pnpm/action-setup@v4
        with:
          version: 8
          run_install: false

      # ── Cache ───────────────────────────────────────────────────────────────
      - name: Get pnpm store path
        id: pnpm-cache
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Restore pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # ── Install ─────────────────────────────────────────────────────────────
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ── Environment ─────────────────────────────────────────────────────────
      # Write .env.production so Next.js picks up the API URL at build time.
      - name: Write apps/web/.env.production
        run: |
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" \
            > apps/web/.env.production

      # ── Build & Deploy ───────────────────────────────────────────────────────
      - name: Deploy to Netlify (build + prod)
        run: npx netlify-cli deploy --build --prod --dir apps/web
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
